<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.finalproject.model.dao.UserDao">

    <resultMap id="UserResultMap" type="com.ssafy.finalproject.model.entity.User">
        <id property="userId" column="user_id"/>
        <result property="loginId" column="login_id"/>
        <result property="password" column="password"/>
        <result property="name" column="name"/>
        <result property="birthDate" column="birth_date"/>
        <result property="gender" column="gender"/>
        <result property="calendarType" column="calendar_type"/>
        <result property="coin" column="coin"/>
        <result property="lastCoinResetAt" column="last_coin_reset_at"/>
        <result property="createdDate" column="created_date"/>
        <result property="updatedDate" column="updated_date"/>
        <result property="deletedDate" column="deleted_date"/>
    </resultMap>

    <!-- 회원가입 -->
    <insert id="insertUser" parameterType="com.ssafy.finalproject.model.entity.User" useGeneratedKeys="true" keyProperty="userId">
        INSERT INTO users (login_id, password, name, birth_date, gender, calendar_type, coin, last_coin_reset_at, created_date)
        VALUES (#{loginId}, #{password}, #{name}, #{birthDate}, #{gender}, #{calendarType}, DEFAULT, CURRENT_TIMESTAMP, NOW())
    </insert>

    <!-- 로그인 아이디로 조회 -->
    <select id="findByLoginId" parameterType="string" resultMap="UserResultMap">
        SELECT *
        FROM users
        WHERE login_id = #{loginId}
          AND deleted_date IS NULL
    </select>

    <!-- 사용자 ID로 조회 -->
    <select id="findById" parameterType="long" resultMap="UserResultMap">
        SELECT *
        FROM users
        WHERE user_id = #{userId}
          AND deleted_date IS NULL
    </select>

    <!-- 사용자 정보 수정 -->
    <update id="updateUser" parameterType="com.ssafy.finalproject.model.entity.User">
        UPDATE users
        SET name = #{name},
            birth_date = #{birthDate},
            gender = #{gender},
            <if test="calendarType != null">
                calendar_type = #{calendarType},
            </if>
            <if test="password != null">
                password = #{password},
            </if>
            updated_date = NOW()
        WHERE user_id = #{userId}
    </update>

    <!-- 하루 코인 리셋 (오늘과 다르면 5로 재설정) -->
    <update id="resetDailyCoin" parameterType="map">
        UPDATE users
        SET coin = 5,
            last_coin_reset_at = CURRENT_TIMESTAMP
        WHERE user_id = #{userId}
          AND (last_coin_reset_at IS NULL OR DATE(last_coin_reset_at) &lt; #{today})
    </update>

    <!-- 코인 차감 (잔액이 충분할 때만) -->
    <update id="consumeCoin" parameterType="map">
        UPDATE users
        SET coin = coin - #{cost}
        WHERE user_id = #{userId}
          AND coin &gt;= #{cost}
    </update>

    <!-- 회원 탈퇴 (Soft Delete) -->
    <update id="deleteUser" parameterType="long">
        UPDATE users
        SET deleted_date = NOW()
        WHERE user_id = #{userId}
    </update>

    <!-- 로그인 아이디 중복 체크 -->
    <select id="countByLoginId" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE login_id = #{loginId}
          AND deleted_date IS NULL
    </select>

</mapper>
